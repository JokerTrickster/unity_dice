---
task_id: 08
name: settings-extension
updated: 2025-09-02T10:51:23Zgithub: https://github.com/JokerTrickster/unity_dice/issues/32epic: main-page-screen
status: pending
priority: low
estimated_hours: 8
depends_on: [01, 07]
created: 2025-09-01T05:00:23Z
---

# Task 08: 설정 섹션 확장 (SettingsManager 활용)

## Overview
기존 SettingsManager를 활용하여 메인 페이지 설정 섹션을 확장합니다. 오디오 설정 (배경음악, 효과음), 로그아웃 기능, 약관 보기, 우편함 접근 기능을 통합된 설정 UI로 제공합니다.

## Technical Requirements

### Settings Extension Strategy
기존 `SettingsManager.cs`를 최대한 재사용하고 UI만 메인 페이지에 맞게 재배치:

```csharp
// 기존 SettingsManager 인터페이스 유지
public class SettingsManager : MonoBehaviour {
    // 기존 메서드들 유지
    public bool IsMusicEnabled { get; set; }
    public bool IsSoundEnabled { get; set; }
    public void SaveSettings();
    public void LoadSettings();
    
    // 메인 페이지용 확장
    public event Action<bool> OnMusicSettingChanged;
    public event Action<bool> OnSoundSettingChanged;
}
```

### UI Components Layout
```
SettingsSection
├── QuickSettings (메인 페이지 상단)
│   ├── MusicToggle (ON/OFF)
│   └── SoundToggle (ON/OFF)
├── ActionButtons
│   ├── MailboxButton (Task 07 연동)
│   ├── TermsButton
│   └── LogoutButton
└── SettingsModal (상세 설정 - 향후 확장용)
    ├── AudioSettings (볼륨 슬라이더)
    ├── GameplaySettings
    └── AccountSettings
```

## Implementation Details

### Core Components
1. **MainPageSettings.cs**
   - 기존 SettingsManager 래퍼 역할
   - 메인 페이지 UI와 설정 데이터 연동
   - 실시간 설정 변경 반영

2. **SettingsSectionUI.cs**
   - 설정 관련 UI 컴포넌트 관리
   - 토글 버튼 상태 동기화
   - 모달 및 다이얼로그 호출

3. **LogoutHandler.cs**
   - AuthenticationManager와 연동한 로그아웃 처리
   - 사용자 데이터 정리 및 초기 화면 전환

### Settings Integration
```csharp
public class MainPageSettings : MonoBehaviour {
    void Start() {
        // 기존 SettingsManager에서 설정 로드
        SettingsManager.Instance.LoadSettings();
        
        // UI 초기 상태 설정
        musicToggle.isOn = SettingsManager.Instance.IsMusicEnabled;
        soundToggle.isOn = SettingsManager.Instance.IsSoundEnabled;
        
        // 이벤트 연결
        SettingsManager.Instance.OnMusicSettingChanged += OnMusicChanged;
        SettingsManager.Instance.OnSoundSettingChanged += OnSoundChanged;
    }
    
    public void OnMusicToggleChanged(bool isEnabled) {
        SettingsManager.Instance.IsMusicEnabled = isEnabled;
        SettingsManager.Instance.SaveSettings();
        
        // 즉시 오디오 적용
        AudioManager.Instance.SetMusicEnabled(isEnabled);
    }
    
    public void OnSoundToggleChanged(bool isEnabled) {
        SettingsManager.Instance.IsSoundEnabled = isEnabled;
        SettingsManager.Instance.SaveSettings();
        
        // 즉시 오디오 적용  
        AudioManager.Instance.SetSoundEnabled(isEnabled);
    }
}
```

### Logout Implementation
```csharp
public class LogoutHandler {
    public void InitiateLogout() {
        ShowLogoutConfirmDialog();
    }
    
    void ShowLogoutConfirmDialog() {
        var dialog = UIManager.Instance.ShowConfirmDialog(
            title: "로그아웃",
            message: "정말 로그아웃하시겠습니까?",
            onConfirm: PerformLogout,
            onCancel: null
        );
    }
    
    async void PerformLogout() {
        try {
            // 1. 진행 중인 매칭 취소
            if (MatchingManager.Instance.IsMatching) {
                await MatchingManager.Instance.CancelMatching();
            }
            
            // 2. WebSocket 연결 해제
            NetworkManager.Instance.DisconnectWebSocket();
            
            // 3. 기존 AuthenticationManager 로그아웃
            await AuthenticationManager.Instance.Logout();
            
            // 4. 로컬 데이터 정리
            ClearLocalUserData();
            
            // 5. 로그인 화면으로 전환
            SceneManager.LoadScene("LoginScene");
            
        } catch (Exception ex) {
            Debug.LogError($"Logout failed: {ex.Message}");
            ShowLogoutErrorDialog();
        }
    }
    
    void ClearLocalUserData() {
        // 캐시된 데이터 정리 (보안상 민감한 데이터만)
        MailboxManager.Instance.ClearCache();
        // 기본 설정은 유지 (음악, 효과음 등)
    }
}
```

### Terms & Conditions
```csharp
public class TermsHandler {
    private const string TERMS_URL = "https://unitydice.com/terms";
    private const string PRIVACY_URL = "https://unitydice.com/privacy";
    
    public void ShowTermsAndConditions() {
        ShowTermsModal();
    }
    
    void ShowTermsModal() {
        var modal = UIManager.Instance.ShowModal("TermsModal");
        
        // 웹뷰 또는 텍스트 표시
        if (Application.platform == RuntimePlatform.Android || 
            Application.platform == RuntimePlatform.IPhonePlayer) {
            OpenWebView(TERMS_URL);
        } else {
            LoadTermsTextFromResources();
        }
    }
    
    void OpenWebView(string url) {
        // 네이티브 웹뷰 열기
        Application.OpenURL(url);
    }
    
    void LoadTermsTextFromResources() {
        var termsText = Resources.Load<TextAsset>("terms_kr").text;
        ShowTermsInScrollView(termsText);
    }
}
```

## Acceptance Criteria

### Functional Requirements
- [ ] 배경음악 on/off 토글 버튼 정상 작동
- [ ] 효과음 on/off 토글 버튼 정상 작동
- [ ] 로그아웃 버튼으로 안전한 로그아웃 처리
- [ ] 약관 보기 버튼으로 이용약관 표시
- [ ] 우편함 버튼으로 우편함 모달 열기 (Task 07 연동)
- [ ] 설정 변경 시 즉시 반영 및 저장

### Technical Requirements
- [ ] 기존 SettingsManager 완전 재사용 (수정 최소화)
- [ ] AuthenticationManager와 연동한 로그아웃 처리
- [ ] 설정 변경 시 PlayerPrefs 자동 저장
- [ ] 매칭 중 로그아웃 시 안전한 상태 정리

### Performance Requirements
- [ ] 설정 변경 반영 시간 즉시 (0.1초 이내)
- [ ] 로그아웃 처리 시간 5초 이내
- [ ] UI 토글 애니메이션 60FPS 유지
- [ ] 메모리 사용량 증가 2MB 이하

## Testing Strategy

### Unit Tests
- `MainPageSettingsTests.cs`: 설정 변경 및 저장 로직
- `LogoutHandlerTests.cs`: 로그아웃 프로세스 및 데이터 정리
- `TermsHandlerTests.cs`: 약관 표시 로직

### Integration Tests
- 기존 SettingsManager와 UI 연동 테스트
- AuthenticationManager 로그아웃 플로우 테스트
- MailboxManager와 우편함 버튼 연동 테스트

### Scenario Tests
- 매칭 중 로그아웃 시나리오
- 설정 변경 후 앱 재시작 시 유지 테스트
- 네트워크 오류 중 로그아웃 시나리오

## Error Handling

### Logout Failures
- 네트워크 오류 시에도 로컬 로그아웃 진행
- 매칭 취소 실패 시 강제 연결 해제
- 로그아웃 과정에서 예외 발생 시 안전한 복구

### Settings Persistence
- PlayerPrefs 저장 실패 시 메모리에 유지
- 설정 로드 실패 시 기본값 사용
- 설정 파일 손상 시 초기화

## Security Considerations

### Data Cleanup
- 로그아웃 시 민감한 사용자 데이터만 정리
- 기본 설정 (음악, 효과음)은 유지
- 인증 토큰 및 개인정보 완전 삭제

### Settings Validation
- 설정값 범위 검증 (불리언 타입 검증)
- 악의적 설정 변경 방지
- 기본값 복구 메커니즘

## Dependencies
- **Internal**: SettingsManager (기존), AuthenticationManager, MailboxManager (Task 07)
- **External**: PlayerPrefs, Unity UI Toggle, Application.OpenURL

## Localization Support
```json
{
  "settings": {
    "music": "배경음악",
    "sound": "효과음",
    "mailbox": "우편함", 
    "terms": "약관 보기",
    "logout": "로그아웃",
    "logoutConfirm": "정말 로그아웃하시겠습니까?",
    "logoutSuccess": "로그아웃되었습니다",
    "logoutFailed": "로그아웃 중 오류가 발생했습니다"
  }
}
```

## Minimal Implementation Approach

이 작업은 대부분 기존 시스템을 재사용하므로 새로운 코드는 최소화:

1. **UI 재배치**: 기존 설정 UI를 메인 페이지 레이아웃에 맞게 조정
2. **이벤트 연결**: 기존 SettingsManager 이벤트를 새 UI에 연결
3. **로그아웃 통합**: 기존 AuthenticationManager.Logout() 활용
4. **우편함 연동**: Task 07의 MailboxManager 버튼 연결

## Definition of Done
- [ ] 모든 설정 기능이 메인 페이지에서 정상 작동
- [ ] 기존 SettingsManager 완전 재사용 (수정 최소화)
- [ ] 로그아웃 기능 안전하고 완전하게 동작
- [ ] 약관 보기 기능 플랫폼별 적절한 방식으로 구현
- [ ] 우편함 연동 정상 작동
- [ ] 단위/통합 테스트 모두 통과
- [ ] 에러 처리 및 사용자 경험 검증 완료
- [ ] 기존 설정 시스템과 100% 호환성 유지