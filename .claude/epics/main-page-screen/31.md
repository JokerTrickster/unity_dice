---
task_id: 07
name: mailbox-system
updated: 2025-09-02T10:51:23Zgithub: https://github.com/JokerTrickster/unity_dice/issues/31epic: main-page-screen
status: pending
priority: medium
estimated_hours: 14
depends_on: [01]
created: 2025-09-01T05:00:23Z
---

# Task 07: 우편함 시스템 구현 (기존 NetworkManager 활용)

## Overview
친구 메시지, 공지사항, 피로도 선물 등을 수신할 수 있는 우편함 시스템을 구현합니다. 기존 NetworkManager의 HTTP API를 활용하여 서버와 데이터를 동기화하고, 읽음/안읽음 상태 관리 기능을 제공합니다.

## Technical Requirements

### Data Models
```csharp
public class MailboxMessage {
    public string messageId;
    public MailMessageType type;
    public string title;
    public string content;
    public Dictionary<string, object> attachments; // 피로도 선물 등
    public DateTime sentAt;
    public DateTime? readAt;
    public bool isRead;
    public string senderId;
    public string senderName;
}

public enum MailMessageType {
    System,         // 시스템 공지사항
    Friend,         // 친구 메시지
    EnergyGift,     // 피로도 선물
    Achievement,    // 성취 보상
    Event           // 이벤트 알림
}

public class MailboxData {
    public List<MailboxMessage> messages;
    public int unreadCount;
    public DateTime lastSyncTime;
}
```

### UI Components
```
SettingsSection (확장)
├── MailboxButton (Badge with unread count)
└── MailboxModal
    ├── MailboxHeader
    │   ├── UnreadCountDisplay
    │   ├── MarkAllReadButton
    │   └── RefreshButton
    ├── MessageList (ScrollRect)
    │   ├── MessageItem (Prefab)
    │   │   ├── TypeIcon (시스템/친구/선물)
    │   │   ├── SenderName
    │   │   ├── MessageTitle
    │   │   ├── SendTime
    │   │   ├── ReadStatusIndicator
    │   │   └── AttachmentIcon (있는 경우)
    │   └── EmptyState ("우편함이 비어있습니다")
    └── MessageDetailModal
        ├── MessageContent
        ├── AttachmentsList
        ├── ClaimButton (선물의 경우)
        └── DeleteButton
```

## Implementation Details

### Core Components
1. **MailboxManager.cs** (Singleton)
   - 기존 NetworkManager HTTP API 활용
   - 메시지 목록 캐싱 및 동기화
   - 읽음/안읽음 상태 관리

2. **MailboxUI.cs**
   - 우편함 모달 UI 관리
   - 메시지 목록 표시 및 페이지네이션
   - 읽지 않은 메시지 개수 뱃지 표시

3. **MessageItemUI.cs**
   - 개별 메시지 아이템 UI 컴포넌트
   - 메시지 타입별 아이콘 및 스타일링
   - 클릭 이벤트 처리

### NetworkManager Integration
```csharp
public class MailboxNetworking {
    // 기존 NetworkManager HTTP 메서드 활용
    public void LoadMessages() {
        NetworkManager.Instance.Get("/api/mailbox/messages", OnMessagesLoaded);
    }
    
    public void MarkAsRead(string messageId) {
        var data = new { messageId = messageId };
        NetworkManager.Instance.Post("/api/mailbox/read", data, OnReadStatusUpdated);
    }
    
    public void ClaimAttachment(string messageId) {
        var data = new { messageId = messageId };
        NetworkManager.Instance.Post("/api/mailbox/claim", data, OnAttachmentClaimed);
    }
    
    public void DeleteMessage(string messageId) {
        NetworkManager.Instance.Delete($"/api/mailbox/messages/{messageId}", OnMessageDeleted);
    }
}
```

### Local Caching Strategy
```csharp
public class MailboxCache {
    private const string MAILBOX_CACHE_KEY = "mailbox_data";
    private const int CACHE_EXPIRY_HOURS = 6;
    
    public void SaveToCache(MailboxData data) {
        data.lastSyncTime = DateTime.UtcNow;
        string json = JsonUtility.ToJson(data);
        // 기존 CryptoHelper 활용하여 암호화 저장
        string encrypted = CryptoHelper.Encrypt(json);
        PlayerPrefs.SetString(MAILBOX_CACHE_KEY, encrypted);
    }
    
    public MailboxData LoadFromCache() {
        if (!PlayerPrefs.HasKey(MAILBOX_CACHE_KEY)) return null;
        
        string encrypted = PlayerPrefs.GetString(MAILBOX_CACHE_KEY);
        string json = CryptoHelper.Decrypt(encrypted);
        var data = JsonUtility.FromJson<MailboxData>(json);
        
        // 캐시 만료 확인
        if (DateTime.UtcNow - data.lastSyncTime > TimeSpan.FromHours(CACHE_EXPIRY_HOURS)) {
            return null;
        }
        
        return data;
    }
}
```

## Message Type Handlers

### Energy Gift Handler
```csharp
public class EnergyGiftHandler {
    public void HandleEnergyGift(MailboxMessage message) {
        var energyAmount = (int)message.attachments["energy"];
        var giftId = message.attachments["giftId"].ToString();
        
        // 선물 수령 처리
        ClaimEnergyGift(message.messageId, energyAmount, giftId);
    }
    
    void ClaimEnergyGift(string messageId, int energy, string giftId) {
        // 1. 서버에 선물 수령 요청
        var claimData = new { 
            messageId = messageId, 
            giftId = giftId 
        };
        
        NetworkManager.Instance.Post("/api/mailbox/claim", claimData, (response) => {
            if (response.IsSuccess) {
                // 2. 로컬 피로도 추가
                EnergyManager.Instance.AddEnergy(energy);
                
                // 3. 메시지를 읽음으로 표시
                MarkMessageAsRead(messageId);
                
                // 4. UI 업데이트
                ShowClaimSuccessDialog(energy);
                RefreshMailbox();
            }
        });
    }
}
```

### System Notification Handler
```csharp
public class SystemNotificationHandler {
    public void HandleSystemMessage(MailboxMessage message) {
        // 시스템 메시지는 자동으로 읽음 처리하지 않음
        // 사용자가 명시적으로 읽어야 함
        
        if (message.attachments != null && message.attachments.ContainsKey("action")) {
            var action = message.attachments["action"].ToString();
            switch (action) {
                case "update_required":
                    ShowUpdateRequiredDialog();
                    break;
                case "maintenance_notice":
                    ShowMaintenanceNotice();
                    break;
                case "event_start":
                    ShowEventNotification();
                    break;
            }
        }
    }
}
```

## Acceptance Criteria

### Functional Requirements
- [ ] 설정 섹션에서 우편함 접근 가능
- [ ] 읽지 않은 메시지 개수 뱃지 표시
- [ ] 친구 메시지, 공지사항, 피로도 선물 수신 및 표시
- [ ] 메시지 읽음/안읽음 상태 관리
- [ ] 피로도 선물 수령 기능
- [ ] 메시지 삭제 기능

### Technical Requirements
- [ ] 기존 NetworkManager HTTP API 완전 재사용
- [ ] PlayerPrefs + CryptoHelper 기반 로컬 캐싱
- [ ] 메시지 타입별 다른 처리 로직
- [ ] 오프라인 모드 지원 (캐시된 데이터 표시)
- [ ] 백그라운드 동기화 지원

### Performance Requirements
- [ ] 우편함 로딩 시간 3초 이내
- [ ] 메시지 목록 스크롤 60FPS 유지
- [ ] 캐시 히트 시 즉시 로딩 (1초 이내)
- [ ] 메모리 사용량 증가 10MB 이하

## Testing Strategy

### Unit Tests
- `MailboxManagerTests.cs`: 메시지 로드, 읽음 처리, 캐싱 로직
- `EnergyGiftHandlerTests.cs`: 피로도 선물 수령 로직
- `MailboxCacheTests.cs`: 로컬 캐싱 및 동기화

### Integration Tests
- NetworkManager와 우편함 API 연동 테스트
- EnergyManager와 피로도 선물 연동 테스트
- 캐시 만료 및 자동 동기화 테스트

### Scenario Tests
- 오프라인에서 온라인으로 전환 시 동기화 테스트
- 대량 메시지 로딩 성능 테스트
- 동시 메시지 읽음 처리 테스트

## Error Handling

### Network Errors
- API 호출 실패 시 캐시된 데이터 표시
- 동기화 실패 시 재시도 메커니즘 (최대 3회)
- 서버 오류 시 사용자 친화적 메시지

### Data Integrity
- 메시지 중복 방지 (messageId 기반)
- 읽음 상태 불일치 시 서버 데이터 우선
- 캐시 손상 시 자동 재동기화

### Gift Claiming Errors
- 피로도 선물 중복 수령 방지
- 수령 실패 시 롤백 처리
- 최대 피로도 초과 시 적절한 안내

## Security Considerations

### Data Protection
- 메시지 내용 암호화 저장 (기존 CryptoHelper 활용)
- API 호출 시 인증 토큰 검증
- 민감한 개인정보 로컬 저장 금지

### Attachment Validation
- 피로도 선물 수량 서버사이드 검증
- 첨부파일 타입 및 크기 제한
- 악성 콘텐츠 필터링

## Dependencies
- **Internal**: NetworkManager (HTTP), EnergyManager, CryptoHelper, PlayerPrefs
- **External**: Unity UI, DateTime, JSON Serialization

## Localization Support
```json
{
  "mailbox": {
    "title": "우편함",
    "empty": "우편함이 비어있습니다",
    "unreadCount": "{0}개의 읽지 않은 메시지",
    "markAllRead": "모두 읽음 처리",
    "delete": "삭제",
    "claim": "받기",
    "energyGiftReceived": "피로도 {0}개를 받았습니다!",
    "giftAlreadyClaimed": "이미 받은 선물입니다",
    "loadingMessages": "메시지를 불러오는 중...",
    "networkError": "네트워크 연결을 확인해주세요"
  }
}
```

## Future Enhancements (Out of Scope)
- 메시지 답장 기능
- 메시지 검색 및 필터링
- 첨부 이미지 지원
- 푸시 알림 연동

## Definition of Done
- [ ] 모든 우편함 기능 정상 작동
- [ ] 기존 NetworkManager HTTP 인프라 완전 재사용
- [ ] 메시지 타입별 처리 로직 모두 구현
- [ ] 피로도 선물 시스템과 완벽 통합
- [ ] 로컬 캐싱 및 오프라인 지원 구현
- [ ] 단위/통합/시나리오 테스트 모두 통과
- [ ] 보안 및 성능 요구사항 달성
- [ ] 사용자 경험 및 접근성 검증 완료