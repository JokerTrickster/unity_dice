---
task_id: 04
name: websocket-client
updated: 2025-09-02T10:51:21Zgithub: https://github.com/JokerTrickster/unity_dice/issues/28epic: main-page-screen
status: pending
priority: critical
estimated_hours: 24
depends_on: [01]
created: 2025-09-01T05:00:23Z
---

# Task 04: WebSocketClient 구현 및 NetworkManager 통합

## Overview
실시간 매칭 시스템을 위한 WebSocket 클라이언트를 구현하고 기존 NetworkManager와 통합합니다. HTTP 통신은 기존 인프라를 유지하고, WebSocket은 매칭 전용으로 사용하는 하이브리드 구조를 구축합니다.

## Technical Requirements

### WebSocket Architecture
```csharp
// NetworkManager 확장
public partial class NetworkManager {
    private WebSocketClient webSocketClient;
    
    public async Task<bool> ConnectWebSocket(string url) { }
    public void SendWebSocketMessage<T>(T message) { }
    public event Action<string> OnWebSocketMessage;
}

// 전용 WebSocket 클라이언트
public class WebSocketClient : IDisposable {
    private WebSocket webSocket;
    public bool IsConnected { get; }
    public event Action<string> OnMessage;
    public event Action<bool> OnConnectionChanged;
}
```

### Protocol Design
```csharp
// 매칭 전용 메시지 프로토콜
public class MatchingMessage {
    public string type; // "join_queue", "room_create", "room_join", "cancel"
    public object payload;
    public string timestamp;
}

public class MatchingRequest {
    public int playerCount; // 2-4
    public string matchType; // "random" or "room"
    public string roomCode; // room join only
    public string playerId;
}
```

## Implementation Details

### Core Components
1. **WebSocketClient.cs**
   - WebSocket-sharp 기반 구현
   - 자동 재연결 메커니즘
   - 메시지 큐잉 및 재전송

2. **MatchingProtocol.cs**
   - 매칭 전용 메시지 직렬화/역직렬화
   - 메시지 타입 검증
   - 프로토콜 버전 관리

3. **NetworkManager Extensions**
   - 기존 HTTP 기능 유지
   - WebSocket 기능 추가 통합
   - 통합된 에러 처리

### WebSocket Integration Pattern
```csharp
public partial class NetworkManager {
    // 기존 HTTP 메서드들 유지
    public void Get(string endpoint, Action<NetworkResponse> callback) { }
    public void Post(string endpoint, object data, Action<NetworkResponse> callback) { }
    
    // 새로운 WebSocket 메서드들
    public async Task<bool> InitializeWebSocket(string wsUrl) {
        webSocketClient = new WebSocketClient();
        return await webSocketClient.Connect(wsUrl);
    }
    
    public void SendMatchingRequest(MatchingRequest request) {
        var message = new MatchingMessage {
            type = "matching_request",
            payload = request,
            timestamp = DateTime.UtcNow.ToString("O")
        };
        webSocketClient.Send(JsonUtility.ToJson(message));
    }
}
```

## Connection Management

### Auto-Reconnection Strategy
```csharp
public class ConnectionManager {
    private int maxReconnectAttempts = 5;
    private float[] retryDelays = { 1f, 2f, 5f, 10f, 30f };
    
    async Task AttemptReconnection() {
        for (int i = 0; i < maxReconnectAttempts; i++) {
            await Task.Delay((int)(retryDelays[i] * 1000));
            if (await webSocketClient.Connect(wsUrl)) {
                OnReconnected?.Invoke();
                return;
            }
        }
        OnReconnectionFailed?.Invoke();
    }
}
```

### Message Queuing System
```csharp
public class MessageQueue {
    private Queue<string> pendingMessages = new Queue<string>();
    private bool isProcessing = false;
    
    public void QueueMessage(string message) {
        pendingMessages.Enqueue(message);
        if (webSocketClient.IsConnected && !isProcessing) {
            ProcessQueue();
        }
    }
    
    async void ProcessQueue() {
        isProcessing = true;
        while (pendingMessages.Count > 0 && webSocketClient.IsConnected) {
            var message = pendingMessages.Dequeue();
            await webSocketClient.Send(message);
        }
        isProcessing = false;
    }
}
```

## Acceptance Criteria

### Functional Requirements
- [ ] WebSocket 서버와 안정적인 연결 수립
- [ ] 매칭 요청/응답 메시지 정상 송수신
- [ ] 연결 끊김 시 자동 재연결 (최대 5회)
- [ ] 기존 NetworkManager HTTP 기능 무손실 유지
- [ ] 메시지 큐잉을 통한 연결 불안정 시 데이터 보호

### Technical Requirements
- [ ] NetworkManager 기존 인터페이스 변경 없음
- [ ] WebSocket-sharp 라이브러리 통합
- [ ] Thread-safe 메시지 처리
- [ ] 메모리 누수 방지 (IDisposable 구현)
- [ ] 설정 파일 기반 WebSocket URL 관리

### Performance Requirements
- [ ] 연결 수립 시간 3초 이내
- [ ] 메시지 송신 지연 100ms 이내
- [ ] 재연결 시도 간격 적절한 백오프 적용
- [ ] 메모리 사용량 증가 10MB 이하

## Testing Strategy

### Unit Tests
- `WebSocketClientTests.cs`: 연결 관리 및 메시지 송수신
- `MatchingProtocolTests.cs`: 메시지 직렬화/역직렬화
- `ConnectionManagerTests.cs`: 재연결 로직 테스트

### Integration Tests
- NetworkManager 기존 HTTP 기능 무손실 검증
- WebSocket + HTTP 동시 사용 시나리오
- Mock WebSocket 서버를 통한 E2E 테스트

### Stress Tests
- 대량 메시지 송수신 안정성
- 빈번한 연결/해제 시나리오
- 네트워크 불안정 환경 시뮬레이션

## Error Handling

### Connection Failures
- 초기 연결 실패 시 재시도 메커니즘
- 재연결 실패 시 사용자 알림 및 HTTP fallback
- 서버 점검 등 장기간 연결 불가 시 대응

### Message Failures  
- 메시지 송신 실패 시 재시도 (최대 3회)
- 잘못된 형식 메시지 수신 시 무시
- 타임아웃된 메시지 자동 제거

### Memory Management
- WebSocket 연결 정리 시 리소스 해제
- 메시지 큐 크기 제한 (최대 100개)
- 주기적 가비지 컬렉션 트리거

## Security Considerations

### Connection Security
- WSS (WebSocket Secure) 프로토콜 사용
- 인증 토큰 기반 연결 검증
- 메시지 페이로드 기본 검증

### Data Protection
- 민감한 데이터 WebSocket 전송 금지
- 메시지 크기 제한 (최대 1MB)
- Rate limiting으로 스팸 방지

## Dependencies
- **Internal**: NetworkManager (확장), 기존 HTTP 인프라
- **External**: WebSocket-sharp (NuGet), Unity Coroutines
- **Configuration**: ConfigManager로 WebSocket URL 관리

## Mock Server for Development
```csharp
// 개발용 Mock WebSocket 서버
public class MockWebSocketServer {
    public void SimulateMatchingResponse(MatchingRequest request) {
        // 랜덤 지연 후 응답 시뮬레이션
        await Task.Delay(Random.Range(500, 2000));
        
        var response = new MatchingResponse {
            success = Random.value > 0.1f, // 90% 성공률
            roomId = request.matchType == "room" ? request.roomCode : GenerateRoomId(),
            players = GenerateMockPlayers(request.playerCount)
        };
        
        SendToClient(JsonUtility.ToJson(response));
    }
}
```

## Configuration Management
```json
{
  "websocketConfig": {
    "url": "wss://game-api.unitydice.com/matching",
    "timeout": 10000,
    "maxReconnectAttempts": 5,
    "retryDelays": [1000, 2000, 5000, 10000, 30000],
    "maxMessageQueueSize": 100,
    "enableHeartbeat": true,
    "heartbeatInterval": 30000
  }
}
```

## Definition of Done
- [ ] WebSocket 클라이언트 기본 기능 완벽 구현
- [ ] NetworkManager와 완벽 통합 (기존 기능 무손실)
- [ ] 자동 재연결 및 메시지 큐잉 시스템 정상 작동
- [ ] Mock 서버로 모든 시나리오 테스트 완료
- [ ] 단위/통합/스트레스 테스트 모두 통과
- [ ] 메모리 누수 및 성능 검증 완료
- [ ] 에러 처리 및 보안 검증 완료
- [ ] 설정 파일 기반 관리 구조 완성