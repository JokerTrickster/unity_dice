---
task_id: 06
name: room-system
updated: 2025-09-02T10:51:22Zgithub: https://github.com/JokerTrickster/unity_dice/issues/30epic: main-page-screen
status: pending
priority: high
estimated_hours: 16
depends_on: [05]
created: 2025-09-01T05:00:23Z
---

# Task 06: 방 생성/참여 시스템 구현

## Overview
친구와 함께 게임하기 위한 방 생성 및 참여 시스템을 구현합니다. 방 생성 시 4자리 숫자 코드를 자동 생성하고, 방 참여하기로 코드를 입력하여 매칭에 참여할 수 있는 기능을 제공합니다.

## Technical Requirements

### UI Components Extension
```
MatchingSection (Task 05 확장)
├── MatchTypeSelector
│   ├── RandomMatchingButton (Task 05)
│   └── RoomMatchingGroup (신규)
│       ├── CreateRoomButton
│       └── JoinRoomButton
└── RoomModals (신규)
    ├── CreateRoomModal
    │   ├── RoomCodeDisplay (4자리 숫자)
    │   ├── CopyCodeButton
    │   ├── WaitingPlayersList
    │   └── StartGameButton (방장 전용)
    └── JoinRoomModal
        ├── RoomCodeInput (4자리 숫자 입력)
        ├── JoinButton
        └── ErrorMessage
```

### Room Data Models
```csharp
public class RoomData {
    public string roomCode;      // 4자리 숫자 ("1234")
    public string hostPlayerId;  // 방장 ID
    public List<PlayerInfo> players;
    public int maxPlayers;       // 선택된 인원수 (2-4)
    public RoomStatus status;    // Waiting, Starting, InGame
    public DateTime createdAt;
}

public class PlayerInfo {
    public string playerId;
    public string nickname;
    public bool isHost;
    public bool isReady;
}

public enum RoomStatus {
    Waiting,    // 플레이어 대기 중
    Starting,   // 게임 시작 중
    InGame,     // 게임 진행 중
    Closed      // 방 종료
}
```

## Implementation Details

### Core Components
1. **RoomManager.cs** (Singleton)
   - 방 생성/참여/나가기 로직 관리
   - WebSocketClient를 통한 실시간 방 상태 동기화
   - 방장 권한 및 게임 시작 조건 검증

2. **RoomUI.cs**
   - 방 생성/참여 모달 UI 관리
   - 실시간 플레이어 목록 업데이트
   - 방장/참여자별 다른 UI 표시

3. **RoomCodeGenerator.cs**
   - 중복되지 않는 4자리 방 코드 생성
   - 코드 유효성 검증
   - 방 코드 만료 시간 관리

### Room Creation Flow
```csharp
public class RoomCreationFlow {
    public async Task<string> CreateRoom(int playerCount) {
        // 1. 피로도 검증
        if (!EnergyManager.Instance.CanStartGame()) {
            ShowEnergyRequiredDialog();
            return null;
        }
        
        // 2. 고유 방 코드 생성
        string roomCode = GenerateUniqueRoomCode();
        
        // 3. 방 생성 요청
        var createRequest = new CreateRoomRequest {
            roomCode = roomCode,
            hostPlayerId = UserDataManager.Instance.GetUserId(),
            maxPlayers = playerCount
        };
        
        // 4. WebSocket으로 방 생성 요청
        await NetworkManager.Instance.SendRoomCreateRequest(createRequest);
        
        return roomCode;
    }
    
    string GenerateUniqueRoomCode() {
        // 4자리 숫자 코드 생성 (1000-9999)
        return Random.Range(1000, 10000).ToString();
    }
}
```

### Room Join Flow  
```csharp
public class RoomJoinFlow {
    public async Task<bool> JoinRoom(string roomCode) {
        // 1. 방 코드 형식 검증
        if (!IsValidRoomCode(roomCode)) {
            ShowInvalidCodeDialog();
            return false;
        }
        
        // 2. 피로도 검증
        if (!EnergyManager.Instance.CanStartGame()) {
            ShowEnergyRequiredDialog();
            return false;
        }
        
        // 3. 방 참여 요청
        var joinRequest = new JoinRoomRequest {
            roomCode = roomCode,
            playerId = UserDataManager.Instance.GetUserId(),
            nickname = UserDataManager.Instance.GetNickname()
        };
        
        // 4. WebSocket으로 방 참여 요청
        await NetworkManager.Instance.SendRoomJoinRequest(joinRequest);
        
        return true;
    }
    
    bool IsValidRoomCode(string code) {
        return code.Length == 4 && int.TryParse(code, out _);
    }
}
```

### WebSocket Protocol Extension
```csharp
// 기존 MatchingMessage 확장
public class RoomMessage {
    public string type; // "create_room", "join_room", "leave_room", "room_update"
    public object payload;
    public string timestamp;
}

// 서버 응답 메시지
public class RoomResponse {
    public bool success;
    public string roomCode;
    public RoomData roomData;
    public string error;
}

void OnRoomWebSocketMessage(string message) {
    var response = JsonUtility.FromJson<RoomResponse>(message);
    
    switch (response.type) {
        case "room_created":
            OnRoomCreated(response);
            break;
        case "room_joined":
            OnRoomJoined(response);
            break;
        case "player_joined":
            OnPlayerJoined(response);
            break;
        case "player_left":
            OnPlayerLeft(response);
            break;
        case "room_closed":
            OnRoomClosed(response);
            break;
    }
}
```

## Room Management Features

### Real-time Player List Update
```csharp
public class RoomPlayerList : MonoBehaviour {
    public Transform playerListParent;
    public GameObject playerItemPrefab;
    
    void UpdatePlayerList(List<PlayerInfo> players) {
        // 기존 UI 요소 정리
        ClearPlayerList();
        
        // 새 플레이어 목록 생성
        foreach (var player in players) {
            var playerItem = Instantiate(playerItemPrefab, playerListParent);
            var playerUI = playerItem.GetComponent<PlayerItemUI>();
            playerUI.SetPlayerInfo(player);
        }
    }
}
```

### Room Code Sharing
```csharp
public class RoomCodeSharing {
    public void CopyRoomCodeToClipboard(string roomCode) {
        GUIUtility.systemCopyBuffer = roomCode;
        ShowTooltip("방 코드가 클립보드에 복사되었습니다!");
    }
    
    public void ShareRoomCode(string roomCode) {
        // 향후 확장: 소셜 공유 기능
        string shareText = $"주사위 게임에 함께 참여하세요! 방 코드: {roomCode}";
        // 네이티브 공유 기능 호출
    }
}
```

### Host Privileges
```csharp
public class HostManager {
    public bool IsHost { get; private set; }
    
    public void OnBecomeHost() {
        IsHost = true;
        EnableHostUI();
    }
    
    public async Task StartGame() {
        if (!IsHost) return;
        
        // 게임 시작 조건 검증
        if (currentRoom.players.Count < 2) {
            ShowNotEnoughPlayersDialog();
            return;
        }
        
        // 모든 플레이어 피로도 검증
        if (!ValidateAllPlayersEnergy()) {
            ShowEnergyRequiredDialog();
            return;
        }
        
        // 게임 시작 요청
        await NetworkManager.Instance.SendStartGameRequest(currentRoom.roomCode);
    }
}
```

## Acceptance Criteria

### Functional Requirements
- [ ] 방 생성 시 고유한 4자리 숫자 코드 자동 생성
- [ ] 방 코드 클립보드 복사 기능
- [ ] 방 코드 입력을 통한 방 참여
- [ ] 실시간 방 내 플레이어 목록 표시
- [ ] 방장 권한으로 게임 시작 가능
- [ ] 방 나가기 및 자동 방 정리 기능

### Technical Requirements  
- [ ] WebSocketClient 기반 실시간 방 상태 동기화
- [ ] 방 코드 중복 방지 메커니즘
- [ ] 방장 권한 관리 및 위임 시스템
- [ ] 네트워크 연결 끊김 시 방 상태 복구

### Performance Requirements
- [ ] 방 생성 응답시간 2초 이내
- [ ] 플레이어 목록 업데이트 지연 1초 이내
- [ ] 방 참여 실패 시 즉시 에러 표시
- [ ] 메모리 사용량 증가 5MB 이하

## Testing Strategy

### Unit Tests
- `RoomManagerTests.cs`: 방 생성/참여/나가기 로직
- `RoomCodeGeneratorTests.cs`: 방 코드 생성 및 중복 검증
- `HostManagerTests.cs`: 방장 권한 관리

### Integration Tests
- WebSocket 기반 실시간 방 상태 동기화 테스트
- 다중 플레이어 방 참여/나가기 시나리오 테스트
- EnergyManager와 방 시작 조건 검증 테스트

### Scenario Tests
- 정상적인 방 생성 및 게임 시작 플로우
- 방 코드 오입력 시나리오
- 방장 나가기 시 권한 위임 시나리오
- 네트워크 불안정 중 방 상태 복구 시나리오

## Error Handling

### Room Creation Failures
- 방 코드 중복 시 자동 재생성
- 서버 오류 시 재시도 옵션 제공
- 최대 재시도 횟수 초과 시 명확한 에러 메시지

### Room Join Failures
- 존재하지 않는 방 코드 입력 시 안내
- 방이 꽉 찬 경우 안내 메시지
- 이미 시작된 게임 방 참여 시도 시 안내

### Connection Management
- 방장 연결 끊김 시 방 관리 권한 위임
- 플레이어 연결 끊김 시 방에서 자동 제거
- 방 내 모든 플레이어 연결 끊김 시 방 자동 삭제

## Security Considerations

### Room Code Security
- 방 코드 브루트포스 공격 방지 (시도 횟수 제한)
- 방 생성 후 일정 시간(30분) 후 자동 만료
- 비정상적 방 생성 요청 차단

### Host Privilege Protection
- 방장 권한 변조 방지 (서버사이드 검증)
- 게임 시작 요청 권한 검증
- 방 설정 변경 권한 제한

## Dependencies
- **Internal**: MatchingUI (Task 05), WebSocketClient (Task 04), EnergyManager (Task 03)
- **External**: Unity UI, Clipboard, Random 시스템

## Analytics & Monitoring
```csharp
public class RoomAnalytics {
    public void TrackRoomCreated(string roomCode, int maxPlayers) {
        // 방 생성 이벤트 로깅
    }
    
    public void TrackRoomJoined(string roomCode, int playerCount) {
        // 방 참여 이벤트 로깅
    }
    
    public void TrackGameStarted(string roomCode, int finalPlayerCount) {
        // 게임 시작 이벤트 로깅
    }
}
```

## Definition of Done
- [ ] 모든 방 생성/참여 기능 정상 작동
- [ ] 실시간 방 상태 동기화 완벽 구현
- [ ] 방장 권한 시스템 및 게임 시작 로직 완성
- [ ] 모든 에러 시나리오 처리 완료
- [ ] 단위/통합/시나리오 테스트 모두 통과
- [ ] 보안 검증 및 성능 기준 달성
- [ ] 사용자 경험 및 접근성 검증 완료
- [ ] 기존 랜덤 매칭 기능과 완벽 통합