---
task_id: 03
name: energy-system
epic: main-page-screen
status: in-progress
priority: high
estimated_hours: 20
depends_on: [01]
created: 2025-09-01T05:00:23Z
updated: 2025-09-02T10:51:20Z
github: https://github.com/JokerTrickster/unity_dice/issues/27
---

# Task 03: EnergyManager 및 피로도 시스템 구현

## Overview
게임 플레이를 제한하는 피로도 시스템을 구현합니다. 현재/최대 피로도 표시, 게임 플레이 제한, 게임 내 재화를 통한 피로도 구매 기능을 포함하며, 기존 NetworkManager를 활용해 서버와 동기화합니다.

## Technical Requirements

### Data Model
```csharp
public class EnergyData {
    public int currentEnergy;
    public int maxEnergy;
    public DateTime lastRecoveryTime;
    public int recoveryRate; // 분당 회복량
    public int costPerPurchase; // 구매당 가격 (게임 내 재화)
}

public class EnergyPurchaseRequest {
    public int amount;
    public string currencyType; // "coins", "gems" 등
}
```

### UI Components
```
EnergySection
├── EnergyDisplay
│   ├── EnergyBar (진행바)
│   ├── EnergyText ("25/100")
│   └── RecoveryTimer ("다음 회복: 3분")
├── PurchaseButton (+ 아이콘)
└── EnergyPurchaseModal
    ├── PurchaseOptions (10, 25, 50 에너지)
    ├── CostDisplay (필요 재화)
    └── PurchaseConfirmation
```

## Implementation Details

### Core Components
1. **EnergyManager.cs** (Singleton)
   - 피로도 데이터 관리 및 자동 회복
   - 게임 플레이 가능 여부 검증
   - 구매 처리 및 서버 동기화

2. **EnergyDisplayUI.cs**
   - 실시간 피로도 표시 업데이트
   - 회복 타이머 카운트다운
   - 시각적 피드백 (색상 변경, 애니메이션)

3. **EnergyPurchaseUI.cs**
   - 구매 옵션 표시
   - 결제 확인 모달
   - 구매 성공/실패 피드백

### Auto Recovery System
```csharp
public class EnergyRecoverySystem : MonoBehaviour {
    void Update() {
        if (Time.time - lastUpdateTime >= 60f) { // 1분마다 체크
            RecoverEnergy();
            lastUpdateTime = Time.time;
        }
    }
    
    void RecoverEnergy() {
        var energyData = EnergyManager.Instance.GetEnergyData();
        if (energyData.currentEnergy < energyData.maxEnergy) {
            EnergyManager.Instance.AddEnergy(energyData.recoveryRate);
        }
    }
}
```

## Integration with Existing Systems

### NetworkManager 연동 (기존 HTTP API 활용)
- `GET /api/user/energy` → 서버에서 현재 피로도 데이터 로드
- `POST /api/energy/purchase` → 피로도 구매 처리
- `PUT /api/user/energy` → 피로도 사용 후 서버 동기화

### Game Currency Integration
- 기존 게임 내 재화 시스템과 연동
- `CurrencyManager.Instance.CanAfford(cost)` → 구매 가능 여부 확인
- `CurrencyManager.Instance.Spend(cost)` → 재화 차감

### Game Flow Integration
```csharp
public bool CanStartGame() {
    return EnergyManager.Instance.GetCurrentEnergy() > 0;
}

public void OnGameStart() {
    EnergyManager.Instance.ConsumeEnergy(1);
}
```

## Acceptance Criteria

### Functional Requirements
- [ ] 피로도를 "현재/최대" 형태로 표시
- [ ] 피로도 부족 시 게임 시작 제한 및 안내 메시지
- [ ] 플러스 버튼 클릭 시 구매 모달 표시
- [ ] 게임 내 재화로 피로도 구매 가능
- [ ] 자동 피로도 회복 시스템 (시간 기반)
- [ ] 구매 확인 다이얼로그 및 성공/실패 피드백

### Technical Requirements
- [ ] EnergyManager Singleton 패턴으로 전역 접근
- [ ] NetworkManager 기존 HTTP 인프라 재사용
- [ ] PlayerPrefs 기반 로컬 데이터 저장 및 서버 동기화
- [ ] 백그라운드에서도 시간 기반 회복 처리
- [ ] 구매 실패 시 트랜잭션 롤백

### Performance Requirements
- [ ] 실시간 UI 업데이트 (1초 간격)
- [ ] 메모리 사용량 증가 5MB 이하
- [ ] 구매 처리 응답시간 3초 이내

## Testing Strategy

### Unit Tests
- `EnergyManagerTests.cs`: 피로도 로직 (소모, 회복, 구매)
- `EnergyRecoveryTests.cs`: 자동 회복 시스템 테스트
- `EnergyValidationTests.cs`: 게임 플레이 가능 여부 검증

### Integration Tests
- NetworkManager를 통한 서버 동기화 테스트
- 게임 내 재화 시스템과 구매 연동 테스트
- 백그라운드 회복 시스템 테스트

### Edge Case Tests
- 앱 종료 후 재실행 시 시간 계산 정확성
- 네트워크 오프라인 시 로컬 데이터 처리
- 동시 구매 요청 방지 테스트

## Error Handling

### Purchase Failures
- 재화 부족 시 명확한 안내 메시지
- 네트워크 오류 시 재시도 옵션 제공
- 서버 오류 시 구매 금액 환불 처리

### Data Synchronization
- 로컬-서버 데이터 불일치 시 서버 데이터 우선
- 구매 중 앱 종료 시 재시작 후 상태 확인
- 타임스탬프 기반 정확한 시간 계산

## Security Considerations

### Purchase Validation
- 서버사이드 구매 검증 필수
- 클라이언트에서 구매 금액 변조 방지
- 중복 구매 방지 메커니즘

### Data Integrity
- 피로도 수치 클라이언트 조작 방지
- 암호화된 로컬 저장 (기존 CryptoHelper 활용)

## Dependencies
- **Internal**: NetworkManager (HTTP), CurrencyManager, PlayerPrefs, CryptoHelper
- **External**: Unity Coroutines, DateTime 시스템

## Configuration
```json
{
  "energyConfig": {
    "maxCapacity": 100,
    "recoveryRate": 1,
    "recoveryIntervalMinutes": 5,
    "purchaseOptions": [
      { "amount": 10, "cost": 100, "currency": "coins" },
      { "amount": 25, "cost": 200, "currency": "coins" },
      { "amount": 50, "cost": 350, "currency": "coins" }
    ]
  }
}
```

## Definition of Done
- [ ] 모든 피로도 관련 기능 정상 작동
- [ ] 기존 NetworkManager와 완벽 통합
- [ ] 자동 회복 시스템이 백그라운드에서 정확히 동작
- [ ] 모든 구매 시나리오 테스트 완료
- [ ] 에러 처리 및 보안 검증 완료
- [ ] 성능 및 메모리 기준 달성
- [ ] 게임 플로우와 완벽 통합 검증